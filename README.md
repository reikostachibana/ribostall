# Overview

`ribostall` provides a Python-based pipeline for:
- Extracting read coverage from `.ribo` files with applied P-site offsets  
- Detecting candidate ribosome stall sites across replicates  
- Performing amino acid enrichment analysis around stall sites

# Installation

Clone repository:
```bash
git clone https://github.com/reikostachibana/ribostall
```

Install dependencies:
```
pip install -r requirements.txt
```

Input Requirements
* `.ribo` file generated by [RiboFlow](https://github.com/ribosomeprofiling/riboflow)
* Reference fasta file
Example `.ribo` files and reference files (human and mouse) can be found in [ribograph_sample_data](https://github.com/ribosomeprofiling/ribograph_sampledata?tab=readme-ov-file)

Supported platforms & versions
* Python: 3.9–3.11
* OS: Linux/macOS

# 1. Generate coverage dictionary

`adj_coverage.py` creates a gzipped pickle file of coverage data with applied P-site offset.

| Argument      | Type   | Default | Required | Description |
|---------------|--------|---------|----------|-------------|
| `--ribo`      | path   | —       | ✅       | Input `.ribo` file |
| `--site-type` | str    | —       | ✅       | `"start"` (monosome) or `"stop"` (disome) for P-site offset |
| `--min-len`   | int    | —       | ✅       | Minimum read length (inclusive) |
| `--max-len`   | int    | —       | ✅       | Maximum read length (inclusive) |
| `--procs`     | int    | 1       | ❌       | Number of parallel processes |
| `--out`       | path   | `cov.pkl.gz` | ✅ | Output gzipped pickle file |
| `--alias`       | flag   | off  | ❌ | DO NOT USE  |

Output:
* Gzipped pickle of dictionary `{replicate: {transcript: coverage_array}}`)

Example input:
```
python adj_coverage.py  \
--ribo "../bxc/bxc_disome.ribo" \
--site-type "stop" \
--min-len 57 \
--max-len 65 \
--procs 9 \
--out "../bxc/cov_di.pkl.gz"
```

# 2. Get stall sites

`stall_sites.py`

| Argument         | Type   | Default | Required | Description |
|------------------|--------|---------|----------|-------------|
| `--pickle`       | path   | —       | ✅       | Coverage pickle (`.pkl.gz`) |
| `--ribo`         | path   | —       | ✅       | Input `.ribo` file |
| `--groups`       | str    | —       | ✅       | group1:rep1,rep2,rep3;group2:rep1,rep2,rep3;group3... |
| `--tx_threshold` | float  | 1.0     | ❌       | Min avg reads/nt to keep transcript |
| `--tx_min_rep`    | int    | 2       | ❌       | Min replicates to support transcript |
| `--min_z`        | float  | 1.0     | ❌       | Min z-score to call stall site |
| `--min_reads`    | int    | 2       | ❌       | Min reads to call stall site |
| `--stall_min_reps` | int   | 2       | ❌       | Min replicates to support stall site |
| `--trim_edges`   | int    | 10      | ❌       | Exclude codons at CDS ends |
| `--min_sep`      | int    | 7       | ❌       | Minimum separation between consensus sites; prefer downstream when closer than this |
| `--pseudocount`   | float  | 0.5     | ❌       | Small value added to all amino acid counts before calculating enrichment, to avoid division by zero and stabilize log2 ratios |
| `--out-json`     | path   | `stalls.jsonl` | ❌ | JSON output file |
| `--motif`        | flag   | off     | ❌       | Run amino acid motif analysis |
| `--reference`    | path   | —       | if `--motif` | Reference FASTA file |
| `--flank-left`   | int    | 10      | ❌       | Codons left of P-site for motif |
| `--flank-right`  | int    | 6       | ❌       | Codons right of P-site for motif |
| `--out-png`      | path   | `motif.png`    | ❌ | Motif plot |
| `--out-csv`      | path   | `motif_csv/`   | ❌ | CSV outputs for motif enrichment |

Example input to check filter thresholds:
```
python stall_sites.py \
--pickle "../bxc/cov_di.pkl.gz" \
--ribo "../bxc/bxc_disome.ribo" \
--groups "kidney:kidney_rep1,kidney_rep2,kidney_rep3;liver:liver_rep1,liver_rep2,liver_rep3;lung:lung_rep1,lung_rep2,lung_rep3" \
--tx_threshold 0.3 \
--min_z 1.0
```

Example input for motif analysis:
```
python stall_sites.py \
--pickle "../bxc/cov_di.pkl.gz" \
--ribo "../bxc/bxc_disome.ribo" \
--groups "kidney:kidney_rep1,kidney_rep2,kidney_rep3;liver:liver_rep1,liver_rep2,liver_rep3;lung:lung_rep1,lung_rep2,lung_rep3" \
--tx_threshold 0.3 \
--min_z 1.0 \
--motif \
--reference "../reference_files/appris_mouse_v2_selected.fa.gz" \
--flank-left 20 \
--flank-right 10
```

# Troubleshooting

Successful run of `adj_coverage.py`:
```
2025-09-29 14:10:03,451  INFO  MainProcess  Experiments: ['kidney_rep1', 'kidney_rep2', 'kidney_rep3', 'liver_rep1', 'liver_rep2', 'liver_rep3', 'lung_rep1', 'lung_rep2', 'lung_rep3']
2025-09-29 14:10:03,451  INFO  MainProcess  Transcripts: 21568 total
2025-09-29 14:10:03,451  INFO  MainProcess  Lengths: 57..65
2025-09-29 14:10:03,451  INFO  MainProcess  Processes: 9, batch_size: 0
2025-09-29 14:10:20,026  INFO  SpawnPoolWorker-1  [kidney_rep1] start: lengths 57..65
2025-09-29 14:10:20,026  INFO  SpawnPoolWorker-2  [kidney_rep2] start: lengths 57..65
2025-09-29 14:10:20,026  INFO  SpawnPoolWorker-3  [kidney_rep3] start: lengths 57..65
2025-09-29 14:10:20,027  INFO  SpawnPoolWorker-6  [liver_rep3] start: lengths 57..65
2025-09-29 14:10:20,026  INFO  SpawnPoolWorker-5  [liver_rep2] start: lengths 57..65
2025-09-29 14:10:20,027  INFO  SpawnPoolWorker-7  [lung_rep1] start: lengths 57..65
2025-09-29 14:10:20,026  INFO  SpawnPoolWorker-4  [liver_rep1] start: lengths 57..65
2025-09-29 14:10:20,027  INFO  SpawnPoolWorker-8  [lung_rep2] start: lengths 57..65
2025-09-29 14:10:20,114  INFO  SpawnPoolWorker-9  [lung_rep3] start: lengths 57..65
2025-09-29 14:10:29,574  INFO  SpawnPoolWorker-4  [liver_rep1] done in 9.55s
2025-09-29 14:10:29,647  INFO  SpawnPoolWorker-3  [kidney_rep3] done in 9.62s
2025-09-29 14:10:29,652  INFO  SpawnPoolWorker-1  [kidney_rep1] done in 9.63s
2025-09-29 14:10:29,664  INFO  SpawnPoolWorker-2  [kidney_rep2] done in 9.64s
2025-09-29 14:10:30,774  INFO  SpawnPoolWorker-8  [lung_rep2] done in 10.75s
2025-09-29 14:10:30,780  INFO  SpawnPoolWorker-6  [liver_rep3] done in 10.75s
2025-09-29 14:10:30,786  INFO  SpawnPoolWorker-7  [lung_rep1] done in 10.76s
2025-09-29 14:10:30,802  INFO  SpawnPoolWorker-5  [liver_rep2] done in 10.77s
2025-09-29 14:10:30,850  INFO  SpawnPoolWorker-9  [lung_rep3] done in 10.74s
2025-09-29 14:11:57,981  INFO  MainProcess  Saved coverage to ../bxc/cov_di.pkl.gz
```

Successful run of `stall_sites.py`:
```
(ribo) (base) uwusers-imac:ribostall chunglab$ python stall_sites.py --pickle "../Gatfield_Share/cov_di.pkl.gz" --ribo "../Gatfield_Share/bxc_disome.ribo" --groups "kidney:kidney_rep1,kidney_rep2,kidney_rep3;liver:liver_rep1,liver_rep2,liver_rep3;lung:lung_rep1,lung_rep2,lung_rep3" --tx_threshold 0.3 --min_z 1.0 --motif --reference "../Gatfield_Share/appris_mouse_v2_selected.fa.gz" --flank-left 20 --flank-right 10
Number of filtered transcripts: 122
Number of total stall sites per group: {'kidney': 902, 'liver': 942, 'lung': 853}
2025-09-30 13:40:32,099  INFO  MainProcess  Saved JSON to ../ribostall_results/stall_sites.jsonl
2025-09-30 13:40:52,687  INFO  MainProcess  Saved image to ../ribostall_results/motif.png
2025-09-30 13:40:52,708  INFO  MainProcess  Saved csv to ../ribostall_results/motif_csv/lung_pwm_log2_enrichment.csv
```
